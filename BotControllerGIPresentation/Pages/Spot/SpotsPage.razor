@page "/MySpotsPage"
@inject ISpotsDimService SpotsDimService;
@inject IUserSpotsService UsersSpotService;
@inject SelectedSpotStateService selectedSpotService;
@if (showWait)
{
    <RadzenText TextStyle="TextStyle.DisplayH3" TextAlign="TextAlign.Center" class="rz-color-base-400">Загрузка...</RadzenText>
    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
}
else
{
    // если у пользователя есть заведения
    if (!spotsIsNullOrEmpty)
    {
        // если завденеий несколько то показываем карусеь выбора заведений или карточки заведений с краткой информацией 
        if (UserSpotsList?.Count() > 1)
        {
            <RadzenStack AlignItems="AlignItems.Center" Wrap="Radzen.FlexWrap.Wrap"  Gap="25px" Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" Style="width: 100%">
                @foreach (var spot in UserSpotsList)
                {
                    <RadzenCard Style="width: 49%; min-width: 200px; background: var(--rz-primary-light) no-repeat 50% 70% fixed url('/images/SelectedSpotBackGroudCard2.svg')" class="rz-border-radius-6 rz-shadow-10 ">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start" Gap="10" >
                            <RadzenImage AlternateText="" Path="images/EmptySpotPhotoWithoutImageBackGroundWhite.png" Style="width: 100px; height: 100px;" />
                            <RadzenStack Gap="0">
                                <RadzenText TextStyle="TextStyle.Overline" class="rz-display-flex rz-mt-2 rz-my-0">Название</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body1"><b>@(spot.Spot?.SpotName)</b></RadzenText>
                                <RadzenText TextStyle="TextStyle.Overline" class="rz-display-flex rz-mt-2 rz-my-0">Адрес</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body1"><b>@(spot.Spot?.FullAdress)</b></RadzenText>
                            </RadzenStack>
                            <RadzenStack Gap="0">
                                <RadzenButton Icon="info" ButtonStyle="ButtonStyle.Dark" Variant="Variant.Outlined"></RadzenButton>
                                        <RadzenButton Icon="brightness_empty" ButtonStyle="ButtonStyle.Dark" Variant="Variant.Outlined" Click="() => selectedSpotService.SelectedSpotName = spot.Spot?.SpotName"></RadzenButton>
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenCard>
                }
            </RadzenStack>
        }
        // если заведение только одно показываем только это заведение 
        else
        {

        }
    }
    // если у пользователя нет заведений показываем страницу регистрации заведения 
    else
    {

        <RadzenRow Gap="0" class="rz-my-12 rz-mx-auto rz-border-radius-6 rz-shadow-10" Style="width: 100%; max-width: 800px; overflow: hidden;">
            <RadzenColumn Size="12" SizeMD="6">
                <RadzenCard class="rz-shadow-0 rz-border-radius-0 rz-text-align-center rz-p-12" Style="height: 100%; background: var(--rz-primary-light) no-repeat 100% 70% fixed url('/images/MySpots.svg')">
                    <RadzenStack Style="width: 100%; height: 100%;" AlignItems="AlignItems.Center" Orientation="Orientation.Vertical" JustifyContent="JustifyContent.Center">
                        <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H2" class="rz-color-white rz-mb-6">Мои заведения</RadzenText>
                        <RadzenText TextStyle="TextStyle.H6" class="rz-color-white rz-mb-6">На данной странице осуществлятся регистрация и уравление заведениями.</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-white">У вас пока что нет ни одного заведения</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-white">Это надо быстро исправить</RadzenText>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="6">
                <RadzenCard class="rz-shadow-0 rz-border-radius-0 rz-p-12">
                    <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H2">
                        Пара шагов для регистрации
                    </RadzenText>
                    <RadzenFormField Text="Название завидения" Variant="Variant.Outlined" Style="width:100%;">
                        <End>
                            <RadzenIcon Icon="signature" IconColor="@NameIcon" />
                        </End>
                        <ChildContent>
                            <RadzenTextBox @bind-Value=@NewSpot.SpotName @onclick="@(args => NameIcon = Colors.Black)"></RadzenTextBox>
                        </ChildContent>

                    </RadzenFormField>
                    <RadzenFormField Text="Страна" Variant="Variant.Outlined" Style="width:100%;">
                        <End>
                            <RadzenIcon Icon="public" IconColor="@RegionColor" />
                        </End>
                        <ChildContent>
                            <RadzenTextBox @bind-Value=@NewSpot.Region @onclick="@(args => RegionColor = Colors.Black)"></RadzenTextBox>
                        </ChildContent>
                    </RadzenFormField>
                    <RadzenFormField Text="Город" Variant="Variant.Outlined" Style="width:100%;">
                        <End>
                            <RadzenIcon Icon="location_city" IconColor="@CityColor" />
                        </End>
                        <ChildContent>
                            <RadzenTextBox @bind-Value=@NewSpot.City @onclick="@(args => CityColor = Colors.Black)"></RadzenTextBox>
                        </ChildContent>
                    </RadzenFormField>
                    <RadzenFormField Text="Улица и дом" Variant="Variant.Outlined" Style="width:100%;">
                        <End>
                            <RadzenIcon Icon="signpost" IconColor="@FullAdressCalor" />
                        </End>
                        <ChildContent>
                            <RadzenTextBox @bind-Value=@NewSpot.FullAdress @onclick="@(args => FullAdressCalor = Colors.Black)"></RadzenTextBox>
                        </ChildContent>
                    </RadzenFormField>
                    <RadzenFormField Text="ИНН организации" Variant="Variant.Outlined" Style="width:100%;">
                        <End>
                            <RadzenIcon Icon="123" IconColor="@InnColor" />
                        </End>
                        <ChildContent>
                            <RadzenMask @bind-Value=@NewSpot.Inn MaxLength="12" Mask="************" CharacterPattern="[0-9]" @onclick="@(args => InnColor = Colors.Black)"></RadzenMask>
                        </ChildContent>
                    </RadzenFormField>
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="width: 100%; margin-top: 10px;">
                        <RadzenButton Click="@Submit" ButtonType="ButtonType.Submit" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Dark" Style="width: 200px;" Variant="Variant.Outlined" Icon="save" Text="Зарегистрировать" />
                    </RadzenStack>

                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>

    }
}

@* 

award_star 
brightness_empty
*@


@code 
{

    private bool showWait = true;

    private UserDTO? AuthUserDTO { get; set; }

    private IEnumerable<UsersSpot>? UserSpotsList = new List<UsersSpot>();
    private IEnumerable<SpotsDim>? SpotsList = new List<SpotsDim>();
    private SpotsDim NewSpot { get; set; } = new();

    private bool spotsIsNullOrEmpty = true;


    private string NameIcon = Colors.Black;
    private string RegionColor = Colors.Black;
    private string CityColor = Colors.Black; 
    private string FullAdressCalor = Colors.Black;
    private string InnColor = Colors.Black;



    protected override async Task OnInitializedAsync()
    {

        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        AuthUserDTO = await CustomAuthStateProvider.GetUserDtoFromAuthenticationStateProvider(UserService);
        if (AuthUserDTO is not null)
        {
            UserSpotsList = await UsersSpotService.GetUserSpotsByUserId(AuthUserDTO.id);
            if (UserSpotsList is null || UserSpotsList.Count() == 0)
            {
                spotsIsNullOrEmpty = true;
            }
            else
            {
                spotsIsNullOrEmpty = false;
            }
        }
        showWait = false;
    }

    private void OnSelectedSpotChange(string? spotName)
    {
        selectedSpotService.SelectedSpotName = spotName!;
        StateHasChanged();
    }
    private async void Submit()
    {
        bool EmptyInfoflag = false;
        if (string.IsNullOrEmpty(NewSpot.SpotName))
        {
            NameIcon = Colors.Danger;
            EmptyInfoflag = true;
        }
        if (string.IsNullOrEmpty(NewSpot.Region))
        {
            RegionColor = Colors.Danger;
            EmptyInfoflag = true;
        }
        if (string.IsNullOrEmpty(NewSpot.City))
        {
            CityColor = Colors.Danger;
            EmptyInfoflag = true;
        }
        if (string.IsNullOrEmpty(NewSpot.FullAdress))
        {
            FullAdressCalor = Colors.Danger;
            EmptyInfoflag = true;
        }
        if (string.IsNullOrEmpty(NewSpot.Inn))
        {
            InnColor = Colors.Danger;
            EmptyInfoflag = true;
        }


        if(EmptyInfoflag)
        {
            return;
        }
        else
        {
            
            var spotFromDb = await SpotsDimService.AddAsync(NewSpot);
            if (spotFromDb is not null)
            {
                var newMapUserSpot = new UsersSpot() { Spotid = spotFromDb.Id, UserId = AuthUserDTO!.id };
                var mapResult = await UsersSpotService.AddAsync(newMapUserSpot);
                if(mapResult is not null)
                {

                }
            }
        }

    }

}
