@page "/login"
@using System.Security.Cryptography;
@inject IUserSpotsService UsersSpotService;
@inject ILocalStorageGenericService<string> LocalStorageServiceTest;

@inject IHotCoffeeMaker<SpotsDim> HotCoffeForUserLogin;
@inject SelectedSpotStateService selectedSpotService;

<RadzenStack Orientation="Orientation.Vertical" JustifyContent="JustifyContent.Center" AlignItems="AlignItems.Center" Style="height: 80vh; width: 100%">
    <RadzenCard Style="width: 500px;">
        <RadzenFieldset Text="Данные аккаунта">
            <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Gap="1rem" >
                <RadzenFormField Text="Почта" Variant="Variant.Outlined" Style="width:100%;">
                    <End>
                        <RadzenIcon Icon="account_circle" />
                    </End>
                    <ChildContent>
                        <RadzenTextBox @bind-Value=@LoginUser.Email></RadzenTextBox>
                    </ChildContent>
                </RadzenFormField>
                <RadzenFormField Text="Пароль" Variant="Variant.Outlined" Style="width:100%;">
                    <ChildContent>
                        <RadzenTextBox @bind-Value="@passwordValue" Visible="@(!passwordVisable)" />
                        <RadzenPassword @bind-Value="@passwordValue" Visible="@passwordVisable" />
                    </ChildContent>
                    <End>
                        <RadzenButton Icon="@(passwordVisable ? "visibility" : "visibility_off")" Click="TogglePassword" Variant="Variant.Text" Size="ButtonSize.Medium" Style="margin-right: -5px;" />
                    </End>
                </RadzenFormField>
                <RadzenButton IsBusy=@submitButtonIsBusy BusyText="Поиск пользователя" Click="@Submit" ButtonType="ButtonType.Submit" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Dark" Style="width: 150px;" Variant="Variant.Outlined" Icon="login" Text="Войти" />
                <RadzenLink Icon="person_add" Path="signup" Text="у меня нет аккаунта" IconColor="@Colors.Info" Style="color: #076791; text-align:center; margin-top: -15px;" />
            </RadzenStack>
        </RadzenFieldset>
    </RadzenCard>
    <RadzenStack Orientation="Orientation.Vertical" JustifyContent="JustifyContent.Center" AlignItems="AlignItems.Center" Style="width: 100%; margin-top: 40px;">
        <RadzenAlert Visible="@alertVisible" AllowClose="false"  AlertStyle="AlertStyle.Danger" Variant="Variant.Filled" Shade="Shade.Lighter" Style="position: fixed; width: 500px;">
            Пользователь не найден! 
            Проверьте введенные данные.
        </RadzenAlert>
    </RadzenStack>
</RadzenStack>

@code 
{
    private UserLoginDto LoginUser { get; set; } = new();
    private string passwordValue { get; set; } = string.Empty;
    private bool passwordVisable { get; set; } = true;
    private bool alertVisible { get; set; } = false;
    private bool submitButtonIsBusy { get; set; } = false;


    // protected override async Task OnInitializedAsync()
    // {
    // }

    private void TogglePassword()
    {
        passwordVisable = !passwordVisable;
    }


    private async void Submit()
    {
        submitButtonIsBusy = true;
        LoginUser.Password = passwordValue;
        var res = await UserService.Login(LoginUser);
        if(!string.IsNullOrEmpty(res))
        {




            submitButtonIsBusy = false;
            alertVisible = false;
            var state = await AuthStateProvider.GetAuthenticationStateAsync();
            var AuthUserDTO = await CustomAuthStateProvider.GetUserDtoFromAuthenticationStateProvider(UserService);
            if (AuthUserDTO is not null)
            {
                LoginUser.Id = AuthUserDTO.id;
                var setUserKey = await HotCoffeForUserLogin.SetHotCoffe(HotCoffeeService, Crypto, LocalStorageServiceTest, jsRuntime, LoginUser);


                var asdf = new SpotsDim()
                    {
                        SpotName = "qwre",
                        Id = 1234,
                        FullAdress = "asfdasfs"
                    };
                var result = await HotCoffeForUserLogin.MakeHotCoffe(HotCoffeeService, Crypto, LocalStorageServiceTest, jsRuntime, asdf, AuthUserDTO.id, "keyNameInStorage");

                var decrypt = await HotCoffeForUserLogin.MakeColdCoffe(HotCoffeeService, Crypto, LocalStorageServiceTest, jsRuntime, asdf, AuthUserDTO.id, "keyNameInStorage");

               
                

                var UserSpotsList = await UsersSpotService.GetUserSpotsByUserId(AuthUserDTO.id);
                if(UserSpotsList is not null && UserSpotsList.Count() != 0)
                {
                    var firstSpot = UserSpotsList.FirstOrDefault();
                    if (firstSpot is not null)
                    {
                        firstSpot.isSelect = true;
                        selectedSpotService.UsersSpots = UserSpotsList.ToList();
                    }
                }
            }
            StateHasChanged();
            NavigationManager.NavigateTo("/", false);
        } 
        else
        {
            submitButtonIsBusy = false;
            alertVisible = true;
        }
        
    }
}
